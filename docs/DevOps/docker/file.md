# Dockerfile

| コマンド   | 説明                                                         |
| ---------- | ------------------------------------------------------------ |
| FROM       | ベースイメージ                                               |
| RUN        | ビルドする際、コンテナで実行するコマンド                     |
| COPY       | ホストからコンテナにコピーするファイル・ディレクトリ         |
| ADD        | COPY の機能に加え、アーカイブの自動展開などを行う            |
| CMD        | コンテナがフォアグラウンドで実行するコマンド                 |
| ENTRYPOINT | コンテナを実行可能ファイルとして使用する際に定義するコマンド |
| ARG        | ビルド時に利用する変数                                       |
| ENV        | コンテナ内の環境変数                                         |
| VOLUME     | マウントするボリューム                                       |
| LABEL      | イメージに追加するメタデータ                                 |
| EXPOSE     | エクスポートするポート                                       |
| USER       | コンテナ実行時のユーザー                                     |
| WORKDIR    | コンテナの作業ディレクトリ                                   |
| ONBUILD    | ビルド完了後に実行するコマンド（ベースイメージで使用）       |

## ベストプラクティス

### 全体

-   コンテナはエファラメル（短命）であるべき
-   いつでも停止・破棄可能であるような最小の構築にすること
-   `dockerignore`ファイルを使う
-   不要なパッケージのインストールを避ける
-   1 コンテナに 1 プロセス
-   サービスとサービスに依存関係がある場合は、`link`を使う
-   レイヤ数を最小にする
-   複数行の引数はアルファベット順に
-   キャッシュについて
-   `build`時に`--no-cache`オプション指定でキャッシュを無効にできる
-   `ADD`と`COPY`はファイルに変更があれば、キャッシュが無効になる
-   `RUN apt-get -y update`等では、キャッシュは有効になる

### FROM

-   公式イメージを用いる。Debian が推奨

### RUN

-   `RUN apt-get update`と`apt-get install`は常に同じ`RUN`文で連結する
-   `apt-get udpate`のキャッシュ問題のため

### ADD と COPY

-   一般的なファイルのコピー用途には、`COPY`を使う
-   `ADD`は、ローカルの`tar`ファイルをイメージに自動展開する際などに使う
-   `COPY`は複数ステップで記述し、`RUN`によるパッケージインストールよりも前に記述する
-   ファイル変更による、キャッシュの無効化が予想されるため

## 参考

-   [docker docs](https://docs.docker.com/)
-   [Dockerfile のベストプラクティス](http://docs.docker.jp/engine/articles/dockerfile_best-practice.html)
